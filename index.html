<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlareDrive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.37/vue.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
      }

      ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
      }

      a {
        text-decoration: none;
        color: inherit;
      }

      input[type="search"] {
        background-color: whitesmoke;
        border: none;
        border-radius: 6px;
        width: 100%;
        padding: 8px;
      }

      .file-item {
        height: 48px;
        padding: 8px 0;
        transition: background-color 0.2s ease-in-out;
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .file-item:hover {
        background-color: #f5f5f5;
      }

      .file-item > div {
        min-width: 0;
      }

      .file-icon {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .file-name {
        white-space: nowrap;
        text-overflow: ellipsis;
        overflow: hidden;
      }

      .file-attr {
        margin-top: 4px;
        color: dimgray;
        font-size: 0.8em;
      }

      .file-attr > span + span {
        margin-left: 8px;
      }

      progress {
        position: fixed;
        bottom: 0;
        width: 100%;
      }

      .upload-button,
      .create-folder-button {
        position: fixed;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgb(243, 128, 32);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
      }

      .upload-button {
        right: 16px;
        bottom: 16px;
      }

      .create-folder-button {
        right: 16px;
        bottom: 80px;
      }
    </style>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" href="/favicon.png" />
  </head>
  <body>
    <div id="app">
      <progress
        v-if="uploadProgress !== null"
        :value="uploadProgress"
        max="100"
      ></progress>
      <label class="create-folder-button" tabindex="0">
        <img
          style="filter: invert(100%)"
          src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/file/create_new_folder/materialicons/36dp/2x/baseline_create_new_folder_black_36dp.png"
          alt="Create folder"
          width="36"
          height="36"
        />
        <button hidden @click="createFolder"></button>
      </label>
      <label class="upload-button" tabindex="0">
        <img
          style="filter: invert(100%)"
          src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/file/upload_file/materialicons/36dp/2x/baseline_upload_file_black_36dp.png"
          alt="Upload"
          width="36"
          height="36"
        />
        <input type="file" id="file" multiple hidden @change="uploadFile" />
      </label>
      <div
        style="position: sticky; top: 0; padding: 8px; background-color: white"
      >
        <input type="search" v-model="search" aria-label="Search" />
      </div>
      <ul>
        <li v-if="cwd !== ''">
          <div
            tabindex="0"
            class="file-item"
            @click="cwd = cwd.replace(/[^\/]+\/$/, '')"
          >
            <div class="file-icon">
              <img
                src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/file/folder/materialicons/36dp/2x/baseline_folder_black_36dp.png"
                width="36"
                height="36"
                alt="Folder"
              />
            </div>
            <span class="file-name">..</span>
          </div>
        </li>
        <li v-for="folder in filteredFolders">
          <div tabindex="0" class="file-item" @click="cwd += folder">
            <div class="file-icon">
              <img
                src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/file/folder/materialicons/36dp/2x/baseline_folder_black_36dp.png"
                width="36"
                height="36"
                alt="Folder"
              />
            </div>
            <span class="file-name" v-text="folder"></span>
          </div>
        </li>
        <li v-for="file in filteredFiles">
          <a :href="`/raw/${file.key}`" target="_blank">
            <div class="file-item">
              <div class="file-icon">
                <img
                  v-if="file.customMetadata.thumbnail"
                  :src="`/raw/_$flaredrive$/thumbnails/${file.customMetadata.thumbnail}.png`"
                  width="36"
                  height="36"
                  alt="Image"
                />
                <svg
                  v-else-if="file.httpMetadata.contentType === 'application/pdf'"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 384 512"
                  width="36"
                  height="36"
                >
                  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
                  <path
                    d="M64 0C28.7 0 0 28.7 0 64V448c0 35.3 28.7 64 64 64H320c35.3 0 64-28.7 64-64V160H256c-17.7 0-32-14.3-32-32V0H64zM256 0V128H384L256 0zM64 224H88c30.9 0 56 25.1 56 56s-25.1 56-56 56H80v32c0 8.8-7.2 16-16 16s-16-7.2-16-16V320 240c0-8.8 7.2-16 16-16zm24 80c13.3 0 24-10.7 24-24s-10.7-24-24-24H80v48h8zm72-64c0-8.8 7.2-16 16-16h24c26.5 0 48 21.5 48 48v64c0 26.5-21.5 48-48 48H176c-8.8 0-16-7.2-16-16V240zm32 112h8c8.8 0 16-7.2 16-16V272c0-8.8-7.2-16-16-16h-8v96zm96-128h48c8.8 0 16 7.2 16 16s-7.2 16-16 16H304v32h32c8.8 0 16 7.2 16 16s-7.2 16-16 16H304v48c0 8.8-7.2 16-16 16s-16-7.2-16-16V304 240c0-8.8 7.2-16 16-16z"
                  />
                </svg>
                <svg
                  v-else-if="(file.httpMetadata.contentType || '').startsWith('video/')"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 384 512"
                  width="36"
                  height="36"
                >
                  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
                  <path
                    d="M365.3 93.38l-74.63-74.64C278.6 6.742 262.3 0 245.4 0H64C28.65 0 0 28.65 0 64l.0065 384c0 35.34 28.65 64 64 64H320c35.2 0 64-28.8 64-64V138.6C384 121.7 377.3 105.4 365.3 93.38zM336 448c0 8.836-7.164 16-16 16H64.02c-8.838 0-16-7.164-16-16L48 64.13c0-8.836 7.164-16 16-16h160L224 128c0 17.67 14.33 32 32 32h79.1V448zM240 288c0-17.67-14.33-32-32-32h-96c-17.67 0-32 14.33-32 32v96c0 17.67 14.33 32 32 32h96c17.67 0 32-14.33 32-32v-16.52l43.84 30.2C292.3 403.5 304 397.6 304 387.4V284.6c0-10.16-11.64-16.16-20.16-10.32L240 304.5V288z"
                  />
                </svg>
                <svg
                  v-else-if="(file.httpMetadata.contentType || '').startsWith('audio/')"
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 384 512"
                  width="36"
                  height="36"
                >
                  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
                  <path
                    d="M365.3 93.38l-74.63-74.64C278.6 6.742 262.3 0 245.4 0L64-.0001c-35.35 0-64 28.65-64 64l.0065 384c0 35.34 28.65 64 64 64H320c35.2 0 64-28.8 64-64V138.6C384 121.7 377.3 105.4 365.3 93.38zM336 448c0 8.836-7.164 16-16 16H64.02c-8.838 0-16-7.164-16-16L48 64.13c0-8.836 7.164-16 16-16h160L224 128c0 17.67 14.33 32 32 32h79.1V448zM171.5 259.5L136 296H92C85.38 296 80 301.4 80 308v56C80 370.7 85.38 376 92 376H136l35.5 36.5C179.1 420 192 414.8 192 404v-136C192 257.3 179.1 251.9 171.5 259.5zM235.1 260.7c-6.25 6.25-6.25 16.38 0 22.62C235.3 283.5 256 305.1 256 336c0 30.94-20.77 52.53-20.91 52.69c-6.25 6.25-6.25 16.38 0 22.62C238.2 414.4 242.3 416 246.4 416s8.188-1.562 11.31-4.688C258.1 410.1 288 380.5 288 336s-29.05-74.06-30.28-75.31C251.5 254.4 241.3 254.4 235.1 260.7z"
                  />
                </svg>
                <svg
                  v-else
                  xmlns="http://www.w3.org/2000/svg"
                  viewBox="0 0 384 512"
                  width="36"
                  height="36"
                >
                  <!--! Font Awesome Pro 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license (Commercial License) Copyright 2022 Fonticons, Inc. -->
                  <path
                    d="M0 64C0 28.65 28.65 0 64 0H229.5C246.5 0 262.7 6.743 274.7 18.75L365.3 109.3C377.3 121.3 384 137.5 384 154.5V448C384 483.3 355.3 512 320 512H64C28.65 512 0 483.3 0 448V64zM336 448V160H256C238.3 160 224 145.7 224 128V48H64C55.16 48 48 55.16 48 64V448C48 456.8 55.16 464 64 464H320C328.8 464 336 456.8 336 448z"
                  />
                </svg>
              </div>
              <div>
                <div class="file-name" v-text="file.key.split('/').pop()"></div>
                <div class="file-attr">
                  <span
                    v-text="new Date(file.uploaded).toLocaleString()"
                  ></span>
                  <span v-text="formatSize(file.size)"></span>
                </div>
              </div>
            </div>
          </a>
        </li>
      </ul>
      <div v-if="loading" style="margin-top: 12px; text-align: center">
        <span>Loading...</span>
      </div>
      <div
        v-else-if="!filteredFiles.length && !filteredFolders.length"
        style="margin-top: 12px; text-align: center"
      >
        <span>No files</span>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data: () => ({
          cwd: new URL(window.location).searchParams.get("p") || "",
          files: [],
          folders: [],
          loading: false,
          search: "",
          uploadProgress: null,
          uploadQueue: [],
        }),

        computed: {
          filteredFiles() {
            let files = this.files;
            if (this.search) {
              files = files.filter((file) =>
                file.key.split("/").pop().includes(this.search)
              );
            }
            return files;
          },

          filteredFolders() {
            let folders = this.folders;
            if (this.search) {
              folders = folders.filter((folder) =>
                folder.includes(this.search)
              );
            }
            return folders;
          },
        },

        methods: {
          async createFolder() {
            try {
              const folderName = window.prompt("Folder name");
              if (!folderName) return;
              const uploadUrl = `/api/items/${this.cwd}${folderName}/_$folder$`;
              await axios.put(uploadUrl, "");
            } catch (error) {
              console.log(`Create folder failed`);
            }
          },

          fetchFiles() {
            this.files = [];
            this.folders = [];
            this.loading = true;
            fetch(`/api/children/${this.cwd}`)
              .then((res) => res.json())
              .then((files) => {
                this.files = files.value;
                this.folders = files.folders;
                this.loading = false;
              });
          },

          formatSize(size) {
            const units = ["B", "KB", "MB", "GB", "TB"];
            let i = 0;
            while (size >= 1024) {
              size /= 1024;
              i++;
            }
            return `${size.toFixed(1)} ${units[i]}`;
          },

          async processUploadQueue() {
            if (!this.uploadQueue.length) {
              this.fetchFiles();
              this.uploadProgress = null;
              return;
            }

            const file = this.uploadQueue.pop(0);
            let thumbnailDigest = null;

            if (file.type.startsWith("image/")) {
              const image = await new Promise((resolve) => {
                var image = new Image();
                image.onload = () => resolve(image);
                image.src = URL.createObjectURL(file);
              });

              const canvas = document.createElement("canvas");
              canvas.width = 144;
              canvas.height = 144;
              var ctx = canvas.getContext("2d");
              ctx.drawImage(image, 0, 0, 144, 144);

              const thumbnailBlob = await new Promise((resolve) =>
                canvas.toBlob((blob) => resolve(blob))
              );

              const digest = await crypto.subtle.digest(
                "SHA-1",
                await thumbnailBlob.arrayBuffer()
              );
              const digestArray = Array.from(new Uint8Array(digest));
              const digestHex = digestArray
                .map((b) => b.toString(16).padStart(2, "0"))
                .join("");

              const thumbnailUploadUrl = `/api/items/_$flaredrive$/thumbnails/${digestHex}.png`;
              await axios.put(thumbnailUploadUrl, thumbnailBlob);
              thumbnailDigest = digestHex;
            }

            try {
              const uploadUrl = `/api/items/${this.cwd}${file.name}`;
              const headers = {};
              if (thumbnailDigest) headers["fd-thumbnail"] = thumbnailDigest;
              await axios.put(uploadUrl, file, {
                headers,
                onUploadProgress: (progressEvent) => {
                  var percentCompleted = Math.round(
                    (progressEvent.loaded * 100) / progressEvent.total
                  );
                  this.uploadProgress = percentCompleted;
                },
              });
            } catch (error) {
              console.log(`Upload ${file.name} failed`);
            }
            setTimeout(this.processUploadQueue);
          },

          uploadFile(e) {
            e.preventDefault();
            const fileElement = document.getElementById("file");
            if (!fileElement.value) return;

            if (this.cwd && !this.cwd.endsWith("/")) this.cwd += "/";

            this.uploadQueue.push(...fileElement.files);
            fileElement.value = null;
            this.processUploadQueue();
          },
        },

        watch: {
          cwd: {
            handler() {
              this.fetchFiles();
              const url = new URL(window.location);
              if ((url.searchParams.get("p") || "") !== this.cwd) {
                url.searchParams.set("p", this.cwd);
                window.history.pushState(null, "", url.toString());
              }
              document.title = `${
                this.cwd.replace(/.*\/(?!$)|\//g, "") || "/"
              } - FlareDrive`;
            },
            immediate: true,
          },
        },

        created() {
          window.addEventListener("popstate", (ev) => {
            const searchParams = new URL(window.location).searchParams;
            if (searchParams.get("p") !== this.cwd)
              this.cwd = searchParams.get("p") || "";
          });
        },
      }).mount("#app");
    </script>
  </body>
</html>
