<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlareDrive</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/3.2.37/vue.global.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/axios/0.27.2/axios.min.js"></script>
    <style>
      body {
        font-family: sans-serif;
        margin: 0;
      }

      ul {
        list-style: none;
        padding-left: 0;
        margin: 0;
      }

      a {
        text-decoration: none;
        color: inherit;
      }

      input[type="search"] {
        background-color: whitesmoke;
        border: none;
        border-radius: 6px;
        width: 100%;
        padding: 8px;
      }

      .file-item {
        height: 48px;
        padding: 8px 0;
        transition: background-color 0.2s ease-in-out;
        display: flex;
        align-items: center;
        cursor: pointer;
      }

      .file-item:hover {
        background-color: #f5f5f5;
      }

      .file-icon {
        width: 48px;
        height: 48px;
        flex-shrink: 0;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .file-attr {
        margin-top: 4px;
        color: dimgray;
        font-size: 0.8em;
      }

      .file-attr > span + span {
        margin-left: 8px;
      }

      progress {
        position: fixed;
        bottom: 0;
        width: 100%;
      }

      .upload-button {
        position: fixed;
        right: 16px;
        bottom: 16px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgb(243, 128, 32);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
      }
    </style>
    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" href="/favicon.png" />
  </head>
  <body>
    <div id="app">
      <progress
        v-if="uploadProgress !== null"
        :value="uploadProgress"
        max="100"
      ></progress>
      <label class="upload-button" tabindex="0">
        <img
          style="filter: invert(100%)"
          src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/file/upload_file/materialicons/36dp/2x/baseline_upload_file_black_36dp.png"
          alt="Upload"
          width="36"
          height="36"
        />
        <input type="file" id="file" multiple hidden @change="uploadFile" />
      </label>
      <div
        style="position: sticky; top: 0; padding: 8px; background-color: white"
      >
        <input type="search" v-model="search" aria-label="Search" />
      </div>
      <ul>
        <li v-if="cwd !== ''">
          <div
            tabindex="0"
            class="file-item"
            @click="cwd = cwd.replace(/[^\/]+\/$/, '')"
          >
            <div class="file-icon">
              <img
                src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/file/folder/materialicons/36dp/2x/baseline_folder_black_36dp.png"
                width="36"
                height="36"
                alt="Folder"
              />
            </div>
            <span>..</span>
          </div>
        </li>
        <li v-for="folder in filteredFolders">
          <div tabindex="0" class="file-item" @click="cwd += folder">
            <div class="file-icon">
              <img
                src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/file/folder/materialicons/36dp/2x/baseline_folder_black_36dp.png"
                width="36"
                height="36"
                alt="Folder"
              />
            </div>
            <span v-text="folder"></span>
          </div>
        </li>
        <li v-for="file in filteredFiles">
          <a :href="`/raw/${file.key}`" target="_blank">
            <div class="file-item">
              <div class="file-icon">
                <img
                  v-if="file.customMetadata.thumbnail"
                  :src="`/raw/_$flaredrive$/thumbnails/${file.customMetadata.thumbnail}.png`"
                  width="36"
                  height="36"
                  alt="Image"
                />
                <img
                  v-else
                  src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/image/image/materialicons/36dp/2x/baseline_image_black_36dp.png"
                  width="36"
                  height="36"
                  alt="Image"
                />
              </div>
              <div>
                <div v-text="file.key.split('/').pop()"></div>
                <div class="file-attr">
                  <span
                    v-text="new Date(file.uploaded).toLocaleString()"
                  ></span>
                  <span v-text="formatSize(file.size)"></span>
                </div>
              </div>
            </div>
          </a>
        </li>
      </ul>
      <div v-if="loading" style="margin-top: 12px; text-align: center">
        <span>Loading...</span>
      </div>
      <div
        v-else-if="!filteredFiles.length && !filteredFolders.length"
        style="margin-top: 12px; text-align: center"
      >
        <span>No files</span>
      </div>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data: () => ({
          cwd: "",
          files: [],
          folders: [],
          loading: false,
          search: "",
          uploadProgress: null,
          uploadQueue: [],
        }),

        computed: {
          filteredFiles() {
            let files = this.files;
            if (this.search) {
              files = files.filter((file) =>
                file.key.split("/").pop().includes(this.search)
              );
            }
            return files;
          },

          filteredFolders() {
            let folders = this.folders;
            if (this.search) {
              folders = folders.filter((folder) =>
                folder.includes(this.search)
              );
            }
            return folders;
          },
        },

        methods: {
          fetchFiles() {
            this.files = [];
            this.folders = [];
            this.loading = true;
            fetch(`/api/children/${this.cwd}`)
              .then((res) => res.json())
              .then((files) => {
                this.files = files.value;
                this.folders = files.folders;
                this.loading = false;
              });
          },

          formatSize(size) {
            const units = ["B", "KB", "MB", "GB", "TB"];
            let i = 0;
            while (size >= 1024) {
              size /= 1024;
              i++;
            }
            return `${size.toFixed(1)} ${units[i]}`;
          },

          async processUploadQueue() {
            if (!this.uploadQueue.length) {
              this.fetchFiles();
              this.uploadProgress = null;
              return;
            }

            const file = this.uploadQueue.pop(0);
            let thumbnailDigest = null;

            if (file.type.startsWith("image/")) {
              const image = await new Promise((resolve) => {
                var image = new Image();
                image.onload = () => resolve(image);
                image.src = URL.createObjectURL(file);
              });

              const canvas = document.createElement("canvas");
              canvas.width = 144;
              canvas.height = 144;
              var ctx = canvas.getContext("2d");
              ctx.drawImage(image, 0, 0, 144, 144);

              const thumbnailBlob = await new Promise((resolve) =>
                canvas.toBlob((blob) => resolve(blob))
              );

              const digest = await crypto.subtle.digest(
                "SHA-1",
                await thumbnailBlob.arrayBuffer()
              );
              const digestArray = Array.from(new Uint8Array(digest));
              const digestHex = digestArray
                .map((b) => b.toString(16).padStart(2, "0"))
                .join("");

              const thumbnailUploadUrl = `/api/items/_$flaredrive$/thumbnails/${digestHex}.png`;
              await axios.put(thumbnailUploadUrl, thumbnailBlob);
              thumbnailDigest = digestHex;
            }

            try {
              const uploadUrl = `/api/items/${this.cwd}${file.name}`;
              const headers = {};
              if (thumbnailDigest) headers["fd-thumbnail"] = thumbnailDigest;
              await axios.put(uploadUrl, file, {
                headers,
                onUploadProgress: (progressEvent) => {
                  var percentCompleted = Math.round(
                    (progressEvent.loaded * 100) / progressEvent.total
                  );
                  this.uploadProgress = percentCompleted;
                },
              });
            } catch (error) {
              console.log(`Upload ${file.name} failed`);
            }
            setTimeout(this.processUploadQueue);
          },

          uploadFile(e) {
            e.preventDefault();
            const fileElement = document.getElementById("file");
            if (!fileElement.value) return;

            if (this.cwd && !this.cwd.endsWith("/")) this.cwd += "/";

            this.uploadQueue.push(...fileElement.files);
            fileElement.value = null;
            this.processUploadQueue();
          },
        },

        watch: {
          cwd: {
            handler() {
              this.fetchFiles();
            },
            immediate: true,
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
