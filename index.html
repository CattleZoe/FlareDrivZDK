<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FlareDrive</title>
    <script src="https://unpkg.com/vue@3"></script>
    <style>
      body {
        font-family: sans-serif;
      }

      ul {
        list-style: none;
        padding-left: 0;
      }

      a {
        text-decoration: none;
        color: inherit;
      }

      .file-item {
        height: 48px;
        transition: background-color 0.2s ease-in-out;
        display: flex;
        align-items: center;
      }

      .file-item:hover {
        background-color: #f5f5f5;
      }

      .file-icon {
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .upload-button {
        position: fixed;
        right: 16px;
        bottom: 16px;
        width: 48px;
        height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
        background-color: rgb(243, 128, 32);
        border-radius: 50%;
        cursor: pointer;
        box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
      }
    </style>
  </head>
  <body>
    <div id="app">
      <label class="upload-button">
        <img
          style="filter: invert(100%)"
          src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/file/upload_file/materialicons/36dp/1x/baseline_upload_file_black_36dp.png"
        />
        <input type="file" id="file" hidden @change="uploadFile" />
      </label>
      <ul>
        <li v-if="cwd !== ''">
          <div class="file-item" @click="cwd = cwd.replace(/[^\/]+\/$/, '')">
            <div class="file-icon">
              <img
                src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/file/folder/materialicons/36dp/1x/baseline_folder_black_36dp.png"
              />
            </div>
            <span>..</span>
          </div>
        </li>
        <li v-for="folder in folders">
          <div class="file-item" @click="cwd += folder">
            <div class="file-icon">
              <img
                src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/file/folder/materialicons/36dp/1x/baseline_folder_black_36dp.png"
              />
            </div>
            <span v-text="folder"></span>
          </div>
        </li>
        <li v-for="file in files">
          <a :href="`/drives/${bucket}/${file.key}:/content`" target="_blank">
            <div class="file-item">
              <div class="file-icon">
                <img
                  src="https://cdnjs.cloudflare.com/ajax/libs/material-design-icons/4.0.0/png/image/image/materialicons/36dp/1x/baseline_image_black_36dp.png"
                />
              </div>
              <span v-text="file.key.split('/').pop()"></span>
            </div>
          </a>
        </li>
      </ul>
    </div>

    <script>
      const { createApp } = Vue;

      createApp({
        data: () => ({ bucket: "BUCKET", cwd: "", files: [], folders: [] }),

        methods: {
          fetchFiles() {
            fetch(`/drives/${this.bucket}/${this.cwd}:/children`)
              .then((res) => res.json())
              .then((files) => {
                this.files = files.value;
                this.folders = files.folders;
              });
          },

          uploadFile(e) {
            e.preventDefault();
            const fileElement = document.getElementById("file");
            if (!fileElement.value) return;

            if (!this.cwd.endsWith("/")) this.cwd += "/";

            var file = fileElement.files[0];
            fileElement.value = null;

            fetch(`/drives/${this.bucket}/${this.cwd}${file.name}:/content`, {
              method: "PUT",
              body: file,
            })
              .then(async (response) => {
                if (response.ok) {
                  console.log(await response.json());
                } else {
                  console.log("Upload failed");
                }
              })
              .catch((error) => {
                console.log("Upload failed");
              });
          },
        },

        watch: {
          cwd: {
            handler() {
              this.fetchFiles();
            },
            immediate: true,
          },
        },
      }).mount("#app");
    </script>
  </body>
</html>
